name: Keep Render Bot Alive

on:
  schedule:
    - cron: '*/30 * * * *'  # Ch·∫°y m·ªói 30 ph√∫t
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: ‚¨áÔ∏è Checkout m√£ ngu·ªìn
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Thi·∫øt l·∫≠p Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ C√†i ƒë·∫∑t th∆∞ vi·ªán
        run: |
          python -m pip install --upgrade pip
          pip install requests matplotlib numpy

      - name: üöÄ Ping endpoint
        run: |
          if [ ! -f ping_log.md ]; then
            echo "| Th·ªùi gian | Tr·∫°ng th√°i | Chi ti·∫øt |" > ping_log.md
            echo "|---|---|---|" >> ping_log.md
          fi
          
          PING_OUTPUT=$(timeout 90s python ping.py 2>&1 || echo "‚è∞ Timeout sau 90s")
          STATUS=$(echo "$PING_OUTPUT" | grep -q "200 OK" && echo "‚úÖ Success" || echo "‚ùå Fail")
          
          echo "| $(date -u '+%Y-%m-%d %H:%M:%S') | $STATUS | $PING_OUTPUT |" >> ping_log.md
          
          if [ $(wc -l < ping_log.md) -gt 32 ]; then
            head -n 2 ping_log.md > ping_log.tmp
            tail -n 30 ping_log.md >> ping_log.tmp
            mv ping_log.tmp ping_log.md
          fi

      - name: üìä C·∫≠p nh·∫≠t chart v√† th·ªëng k√™
        run: |
          (head -n 2 ping_log.md && tail -n 30 ping_log.md) > ping_log_short.md
          tail -n +3 ping_log.md | tail -n 30 > log_for_chart.txt
          python plot_uptime.py

          TOTAL=$(wc -l < log_for_chart.txt)
          if [ "$TOTAL" -eq 0 ]; then
            UPTIME_PERCENT=0
          else
            SUCCESS=$(grep -c "‚úÖ" log_for_chart.txt)
            UPTIME_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($SUCCESS/$TOTAL)*100}")
          fi
          echo "$UPTIME_PERCENT" > uptime_percent.txt

      - name: üü¢ T·∫°o badge
        run: |
          LAST_STATUS=$(tail -n 1 ping_log.md | grep -q "‚úÖ" && echo "Online" || echo "Offline")
          COLOR=$([ "$LAST_STATUS" = "Online" ] && echo "brightgreen" || echo "red")
          echo "![Uptime](https://img.shields.io/badge/uptime-$LAST_STATUS-$COLOR)" > uptime_badge.md

      - name: üîÑ C·∫≠p nh·∫≠t README
        run: |
          CURRENT_TIME=$(date -u '+%Y-%m-%d %H:%M:%S')
          TOTAL_PINGS=$(wc -l < log_for_chart.txt)
          UPTIME_PERCENT=$(cat uptime_percent.txt)

          {
            echo "<div align=\"center\">"
            echo
            echo "# üö¶ Render Service Status"
            echo
            echo "<!--badge-start-->"
            cat uptime_badge.md
            echo "<!--badge-end-->"
            echo
            echo "**Monitoring:** \`telegram-template-bot.onrender.com\`"
            echo
            echo "| Metric | Value |"
            echo "|:--|:--|"
            echo "| ‚è∞ Last Update | $CURRENT_TIME UTC |"
            echo "| üîÑ Total Pings | $TOTAL_PINGS |"
            echo "| ‚úÖ Uptime (30 l·∫ßn g·∫ßn nh·∫•t) | $UPTIME_PERCENT% |"
            echo "| ‚åõ Ping Interval | 30 ph√∫t |"
            echo
            echo "</div>"
            echo
            echo "## üìä Uptime Chart"
            echo "<!--chart-start-->"
            echo "![Uptime Chart](uptime_chart.png)"
            echo "<!--chart-end-->"
            echo
            echo "<details><summary>üìù L·ªãch s·ª≠ Ping (30 l·∫ßn g·∫ßn nh·∫•t)</summary>"
            echo
            echo "<!--ping-log-start-->"
            cat ping_log_short.md
            echo "<!--ping-log-end-->"
            echo
            echo "</details>"
            echo
            echo "<div align=\"center\">"
            echo
            echo "---"
            echo
            echo "<sub>‚ö°Ô∏è Powered by [render-monitor](https://github.com/vhd0/render-monitor) | üïí C·∫≠p nh·∫≠t m·ªói 30 ph√∫t</sub>"
            echo
            echo "</div>"
          } > README.md.new

          mv README.md.new README.md

      - name: üíæ Commit thay ƒë·ªïi
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add README.md ping_log.md uptime_badge.md uptime_chart.png

          if ! git diff --staged --quiet; then
            git commit -m "ü§ñ C·∫≠p nh·∫≠t uptime [skip ci]" -m "- Th·ªùi gian: $(date -u '+%Y-%m-%d %H:%M:%S') UTC" -m "- Badge & Chart ƒë√£ c·∫≠p nh·∫≠t" -m "- Log m·ªõi ƒë√£ th√™m"
            git pull --rebase origin main
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
